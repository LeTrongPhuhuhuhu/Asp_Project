@model _6TL.Models.Product
<head>
    <link href="~/css/admin/suasanpham.css" rel="stylesheet" />
</head>

<div class="container_ssp">
    <h2>
        <a href="/Admin/Home/QuanLySanPham" class="back-to-product-management">Quản lý sản phẩm</a> &gt;
        <a href="/Admin/Home/SuaSanPham" class="edit-product-link">Sửa sản phẩm</a>
    </h2>

    <form class="edit-product-form_ssp" method="post" enctype="multipart/form-data">
        @Html.AntiForgeryToken()
        <input type="hidden" name="ProductId" value="@Model.ProductId" />

        <!-- Tên sản phẩm -->
        <div class="form-row_ssp">
            <label for="product-name">Tên sản phẩm</label>
            <input type="text" id="ProductName" name="ProductName" value="@Model.ProductName" required />
        </div>

        <!-- Giá bán -->
        <div class="form-row_ssp">
            <label for="price">Giá bán</label>
            <input type="text" id="Price" name="Price" value="@Model.Price" required />
        </div>

        <!-- Màu sắc -->
        <div class="form-row_ssp">
            <label for="color">Màu sắc</label>
            <div class="product-colors">
                @foreach (var productColor in ViewBag.ProductColors as List<ProductColor>)
                {
                    <div class="color-item">
                        <!-- Dropdown hiển thị màu sắc chỉ từ cơ sở dữ liệu -->
                        <select name="colorId" class="form-control" onchange="updateQuantity(this)">
                            <option value="@productColor.ColorId" data-quantity="@productColor.Quantity">
                                @productColor.Color.ColorName
                            </option>
                        </select>

                        <!-- Input số lượng cho từng màu, hiển thị đúng số lượng hiện tại -->
                        <input type="number" name="quantities[@productColor.ColorId]"
                               value="@productColor.Quantity" min="1" class="form-control" />
                        <button type="button" class="remove-color-btn" onclick="removeColor(this)">Xóa màu</button>
                    </div>
                }
            </div>

            @* Chỉ hiển thị các màu sắc từ cơ sở dữ liệu *@
            <label for="them-mau_ssp">Thêm màu mới</label>
            <select id="them-mau_ssp" name="NewColorId" onchange="addColor()">
                <option value="" disabled selected>Chọn màu</option>
                @foreach (var color in ViewBag.Colors as List<Color>)
                {
                    <option value="@color.ColorId" data-color-name="@color.ColorName">@color.ColorName</option>
                }
            </select>
        </div>

        <!-- Danh mục -->
        <div class="form-row_ssp">
            <label for="category">Danh mục</label>
            <input type="text" id="category" name="CategoryName" value="@Model.Category?.CategoryName" readonly />
            <input type="hidden" name="CategoryId" value="@Model.CategoryId" />
        </div>

        <!-- Nhà cung cấp -->
        <div class="form-row_ssp">
            <label for="supplier">Nhà cung cấp</label>
            <input type="text" id="supplier" name="SupplierName" value="@Model.Supplier?.SupplierName" readonly />
        </div>

        <!-- Chất liệu -->
        <div class="form-row_ssp">
            <label for="material">Chất liệu</label>
            <input type="text" id="Material" name="Material" value="@Model.Material" required />
        </div>

        <!-- Mô tả sản phẩm -->
        <div class="form-row_ssp">
            <label for="description">Mô tả</label>
            <textarea id="ProductDescription" name="ProductDescription" rows="5" required>@Model.ProductDescription</textarea>
        </div>

        <!-- Khu vực hình ảnh -->
        <div class="form-row_ssp">
            <label for="image">Hình ảnh hiện tại</label>
            <div class="current-image">
                <img src="@Model.Image" name="Image" alt="Current Product Image" />
            </div>
            <label for="image-upload">Cập nhật hình ảnh</label>
            <input type="file" id="image-upload" name="ImageFile" accept="image/*" />
        </div>

        <!-- Nút hành động -->
        <div class="button-group_ssp">
            <button type="submit" class="save-btn_ssp">Lưu thay đổi</button>
            <a href="/Admin/Home/QuanLySanPham" class="cancel-btn_ssp">Hủy</a>
        </div>

    </form>
    <script>
        // Hàm cập nhật số lượng cho màu đã chọn
        function updateQuantity(selectElement) {
            var selectedOption = selectElement.options[selectElement.selectedIndex];
            var quantity = selectedOption.getAttribute("data-quantity");

            // Tìm input số lượng tương ứng và cập nhật giá trị
            var quantityInput = selectElement.closest('.color-item').querySelector('input[type="number"]');
            quantityInput.value = quantity || 0;
        }

        // Hàm thêm màu mới vào sản phẩm
        function addColor() {
            var selectedColorId = document.getElementById("them-mau_ssp").value;
            if (selectedColorId) {
                var colorName = document.querySelector("#them-mau_ssp option[value='" + selectedColorId + "']").getAttribute("data-color-name");

                var container = document.querySelector('.product-colors');

                // Kiểm tra xem màu đã được thêm chưa (không thêm màu trùng)
                var colorExists = false;
                var colorItems = container.querySelectorAll('.color-item select');
                colorItems.forEach(function (select) {
                    if (select.value === selectedColorId) {
                        colorExists = true;
                    }
                });

                // Nếu màu chưa có, thêm nó
                if (!colorExists) {
                    var newColorRow = document.createElement('div');
                    newColorRow.classList.add('color-item');
                    newColorRow.innerHTML = `
                                <select name="colorId" class="form-control" onchange="updateQuantity(this)">
                                    <option value="${selectedColorId}" selected>${colorName}</option>
                                </select>
                                <input type="number" name="quantities[${selectedColorId}]" value="1" min="1" class="form-control" />
                                <button type="button" class="remove-color-btn" onclick="removeColor(this)">Xóa màu</button>
                            `;
                    container.appendChild(newColorRow);
                } else {
                    alert('Màu này đã được thêm rồi!');
                }
            }
        }

        // Hàm xóa màu
        function removeColor(button) {
            var colorItem = button.closest('.color-item');
            colorItem.remove();
        }
    </script>
</div>
